<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <title>æ¶ˆé˜²ç‰¹è€ƒç­å€éšŠé•·æ„å‘åŒæ„æ›¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.7/dist/signature_pad.umd.min.js"></script>
  <style>
    body{background:linear-gradient(135deg,#1a2980,#26d0ce);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;}
    .container{width:100%;max-width:740px;background:rgba(255,255,255,.98);border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,.18);overflow:hidden;}
    header{background:linear-gradient(90deg,#4285f4,#34a853);color:#fff;text-align:center;padding:28px 18px 20px 18px;}
    header h1{font-size:2.1rem;margin-bottom:8px;}
    header p{font-size:1.12rem;}
    .content{padding:32px 22px 25px 22px;}
    .form-title{font-size:1.32rem;text-align:center;color:#2566c7;font-weight:700;margin-bottom:26px;}
    form{max-width:410px;margin:0 auto;}
    .form-group{margin-bottom:23px;}
    .form-group label{font-weight:600;display:block;margin-bottom:8px;}
    .form-group input{width:100%;padding:12px;font-size:1.05rem;border-radius:7px;border:1.3px solid #b2bdd2;background:#f7fafc;}
    .form-group input:focus{border-color:#256ad7;}
    .radio-group{display:flex;gap:22px;margin-top:8px;}
    .radio-option{display:flex;align-items:center;gap:6px;}
    .signature-section{margin:32px 0 16px 0;}
    .signature-title{text-align:center;margin-bottom:15px;color:#4285f4;font-size:1.13rem;font-weight:600;}
    .canvas-container{border:2px dashed #c0c0c0;border-radius:13px;background:#f9f9f9;position:relative;overflow:hidden;margin-bottom:18px;}
    #signatureCanvas{width:100%;min-width:180px;height:150px;display:block;cursor:crosshair;background:#fff;touch-action:none;border-radius:7px;}
    .canvas-placeholder{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#999;font-size:1.08rem;pointer-events:none;text-align:center;z-index:0;}
    .controls{display:flex;gap:14px;justify-content:center;}
    .btn{padding:12px 28px;border:none;border-radius:50px;font-size:1.05rem;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:10px;min-width:120px;}
    .btn-clear{background:linear-gradient(135deg,#ff6b6b,#ff8e8e);color:#fff;}
    .btn-submit{background:linear-gradient(135deg,#4285f4,#34a853);color:#fff;}
    .status{display:none;text-align:center;margin-top:28px;}
    .status-success{background:linear-gradient(135deg,#d4edda,#c3e6cb);color:#155724;padding:27px 16px 17px 16px;border-radius:13px;}
    .status-error{background:linear-gradient(135deg,#fce8e6,#fbd4d1);color:#c5221f;padding:27px 16px 17px 16px;border-radius:13px;}
    .status a{color:#256ad7;font-weight:bold;text-decoration:underline;}
    @media(max-width:650px){
      .container{max-width:99vw;}
      .content{padding:17px 6vw 16px 6vw;}
      .form-title{font-size:1.09rem;}
      #signatureCanvas{height:95px;}
      .btn{padding:12px 0;font-size:.99rem;min-width:85px;}
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1><i class="fas fa-signature"></i> æ¶ˆé˜²ç‰¹è€ƒç­å€éšŠé•·æ„å‘åŒæ„æ›¸</h1>
    <p>è«‹æ­£ç¢ºå¡«å¯«ä¸‹åˆ—è¡¨å–®ä¸¦ç°½åï¼Œå®Œæˆå¾Œé»æ“Šæäº¤</p>
  </header>
  <div class="content">
    <div class="form-title">â€” æ„å‘åŒæ„æ›¸å¡«å¯« â€”</div>
    <form id="agreementForm" autocomplete="off">
      <div class="form-group">
        <label for="name">å§“å *</label>
        <input type="text" id="name" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
      </div>
      <div class="form-group">
        <label for="idNumber">èº«åˆ†è­‰å­—è™Ÿ *</label>
        <input type="text" id="idNumber" required placeholder="A123456789">
      </div>
      <div class="form-group">
        <label for="email">å…¬å‹™ä¿¡ç®± *</label>
        <input type="email" id="email" required placeholder="example@gov.taipei">
      </div>
      <div class="form-group">
        <label for="fillTime">å¡«å¯«æ™‚é–“ *</label>
        <input type="datetime-local" id="fillTime" required>
      </div>
      <div class="signature-section">
        <div class="signature-title">ç°½å *</div>
        <div class="canvas-container" style="position:relative;">
          <canvas id="signatureCanvas"></canvas>
          <div class="canvas-placeholder" id="canvasPlaceholder"><i class="fas fa-pen"></i> è«‹åœ¨æ­¤å€åŸŸç°½å</div>
        </div>
        <div class="controls">
          <button class="btn btn-clear" type="button" id="clearBtn"><i class="fas fa-eraser"></i> æ¸…é™¤ç°½å</button>
        </div>
      </div>
      <div class="form-group">
        <label>114å¹´æ¶ˆé˜²ç‰¹è€ƒç­å€éšŠé•·æ„é¡˜ *</label>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="willingness" value="æœ‰æ„é¡˜" required checked> æœ‰æ„é¡˜
          </label>
          <label class="radio-option">
            <input type="radio" name="willingness" value="ç„¡æ„é¡˜"> ç„¡æ„é¡˜
          </label>
        </div>
      </div>
      <div class="controls">
        <button class="btn btn-submit" type="submit"><i class="fas fa-paper-plane"></i> æäº¤åŒæ„æ›¸</button>
      </div>
    </form>
    <div class="status status-success" id="successMsg">
      <i class="fas fa-check-circle" style="font-size:2rem;"></i>
      <div style="font-weight:700;font-size:1.10rem;margin-top:6px;">PDF å·²ç”¢ç”Ÿï¼Œè«‹é»ä¸‹æ–¹ä¸‹è¼‰ï¼š</div>
      <div id="pdfLink" style="margin:14px 0 7px 0"></div>
    </div>
    <div class="status status-error" id="errorMsg">
      <i class="fas fa-exclamation-triangle" style="font-size:2rem;"></i>
      <div style="font-weight:700;font-size:1.08rem;margin-top:5px;">é€å‡ºå¤±æ•—</div>
      <div id="errDetail" style="margin-top:7px;"></div>
    </div>
  </div>
</div>
<script>
  // ==== ç•«å¸ƒè‡ªé©æ‡‰èˆ‡ç°½åæç¤º ====
  const canvas = document.getElementById('signatureCanvas');
  let signaturePad;
  function resizeCanvas(){
    const container = canvas.parentElement;
    const ratio = Math.max(window.devicePixelRatio||1,1);
    let oldData = signaturePad ? signaturePad.toData() : null;
    canvas.width = container.clientWidth * ratio;
    canvas.height = parseFloat(getComputedStyle(canvas).height) * ratio;
    canvas.style.width = container.clientWidth+'px';
    const ctx = canvas.getContext('2d');
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(ratio,ratio);
    if(signaturePad){
      signaturePad.clear();
      signaturePad = new SignaturePad(canvas,{backgroundColor:'#fff',penColor:'#222'});
      if(oldData) signaturePad.fromData(oldData);
    }else{
      signaturePad = new SignaturePad(canvas,{backgroundColor:'#fff',penColor:'#222'});
    }
    signaturePad.addEventListener('beginStroke',()=>{document.getElementById('canvasPlaceholder').style.display='none';});
    if (signaturePad.isEmpty()) document.getElementById('canvasPlaceholder').style.display='block';
    else document.getElementById('canvasPlaceholder').style.display='none';
  }
  window.addEventListener('DOMContentLoaded',()=>{
    resizeCanvas();
    window.addEventListener('resize',resizeCanvas);
    document.getElementById('clearBtn').onclick = ()=>{ signaturePad.clear(); document.getElementById('canvasPlaceholder').style.display='block'; };
    setNow();
  });
  function setNow() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById("fillTime").value = `${year}-${month}-${day}T${hours}:${minutes}`;
  }

  // ==== é€å‡ºè¡¨å–®åˆ° GASï¼Œé¡¯ç¤º PDF é€£çµ ====
  document.getElementById("agreementForm").onsubmit = async function(e){
    e.preventDefault();
    if(signaturePad.isEmpty()){
      showMsg(false,"è«‹ç°½å");
      return;
    }
    if(!document.getElementById("name").value || !document.getElementById("idNumber").value || !document.getElementById("email").value){
      showMsg(false,"è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½");
      return;
    }
    const data = {
      name: document.getElementById("name").value,
      idNumber: document.getElementById("idNumber").value,
      email: document.getElementById("email").value,
      fillTime: document.getElementById("fillTime").value,
      willingness: document.querySelector('input[name="willingness"]:checked').value,
      signature: signaturePad.toDataURL()
    };
    // GAS API ç«¯é»ï¼ˆé€™è£¡æ˜¯ä½ çš„æ–°ç‰ˆç¶²å€ï¼ï¼‰
    const url = "https://script.google.com/macros/s/AKfycbw9hxtUQdE1TcYHCnQrBtoOsyUlm2cLqSafo6TuuHxrxUU2i2TirICEyrN_KTV5or2B6Q/exec";
    showMsg(null,"è™•ç†ä¸­â€¦");
    fetch(url, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(res => {
      if(res.success && res.pdfUrl){
        document.getElementById("pdfLink").innerHTML =
          `<a href="${res.pdfUrl}" target="_blank">ğŸ“„ ä¸‹è¼‰ PDF</a>`;
        showMsg(true);
        document.getElementById("agreementForm").reset();
        signaturePad.clear();
        setNow();
      } else {
        showMsg(false, res.error || "ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      }
    })
    .catch(err => showMsg(false, "é€£ç·šå¤±æ•—ï¼š" + err));
  };
  function showMsg(isOK, txt){
    document.getElementById("successMsg").style.display = isOK === true ? "block" : "none";
    document.getElementById("errorMsg").style.display = isOK === false ? "block" : "none";
    if(isOK === false) document.getElementById("errDetail").innerText = txt||"";
    if(isOK === null){ // è™•ç†ä¸­
      document.getElementById("successMsg").style.display = "none";
      document.getElementById("errorMsg").style.display = "block";
      document.getElementById("errDetail").innerText = txt||"";
    }
    if(isOK === true) document.getElementById("errDetail").innerText = "";
  }
</script>
</body>
</html>
